<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Goat clicker</title>
    <link href="Content/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Content/css/styles.css">
    <link rel="stylesheet" href="Content/css/queries.css">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <!-- Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Sintony:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

</head>
<body>
    <header class="clearfix" id="accueil">
        <div class="logo col-md-3">
            <h2 class="logo-text">GOAT CLICKER</h2>
        </div>
        <nav class="clearfix">
            <ul class="clearfix">
                <li><a href="#accueil" class="active">Accueil</a></li>
            </ul>
        </nav>
        <div class="pullcontainer">
            <a href="#" id="pull"><i class="fa fa-bars fa-2x"></i></a>
        </div>
    </header>

    <div class="h2-wrap" id="titre">
        <div class="container">
            <div class="row">
                <div class="col-md-7 centrer">
                    <h2 class="standard-block">LET'S GOAT SOME GOATS</h2>
                </div>
                <div class="col-md-5 centrer">
                    <p class="standard-block">GOAT$$ : <label id="lblGoats"></label></p>
                </div>
            </div>
        </div>
    </div>
    <div class="container noselect">
        <div class="row">
            <div class="col-md-7 carousel">
                <img src="Content/img/maingoat.jpg" style="width: 300px;" id="mainGoat" alt="main goat" />
                <p id="scoringclick"></p>
                <br />                

                <br />
                <button id="btnSave">Save</button> | <button id="btnReinit">Reinitialiser</button>

            </div>
            <div class="col-md-5" id="beginnerStore" style="border-left : 1px solid #c2c2c2;border-right : 1px solid #c2c2c2;">
                <div class="h2-wrap centrer">
                    <h2 class="standard-block">GOATS STORE</h2>
                </div>
                <!--<div class="competence" id="goatclickproducer">GOAT CLICK PRODUCER
                    <br/>
                    COST : <label id="goatclickproducer_cost"></label> GOAT$$</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>
                <div class="competence">GOAT CLICK PRODUCER</div>-->
            </div>
        </div>
    </div>



    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h2>GOAT CLICKER</h2>

                </div>
                <div class="col-md-4">
                    <p>Ce jeu a été développé par Yves Philippot, Paul Fournier, Damien Laporte & Matthieu Verley</p>
                </div>
                <div class="col-md-3">
                    <p></p>
                </div>
                <div class="col-md-2">
                    <ul class="footer-links">
                        <li><a href="#accueil">Accueil</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>
    <script type="text/javascript" src="Scripts/sound.js"></script>
    <script type="text/javascript" src="Scripts/banque.js"></script>
    <script type="text/javascript" src="Scripts/effet.js"></script>
    <script type="text/javascript" src="Scripts/goat.js"></script>
    <script type="text/javascript" src="Scripts/moralite.js"></script>
    <script type="text/javascript" src="Scripts/competence.js"></script>
    <script type="text/javascript" src="Scripts/player.js"></script>
    <script type="text/javascript" src="Scripts/magasins.js"></script>
    <script type="text/javascript" src="Scripts/si.js"></script>
    <script type="text/javascript" src="Scripts/begin.js"></script>
    <script type="text/javascript" src="Scripts/importexport.js"></script>
    <script type="text/javascript">
        $(function () {

            var chaineSave = getSauvegarde();
            var retrievedObject = JSON.parse(chaineSave);
            var sysinfos = new SysInfos();

            var interval;

            var nbClick = 0;
            var production_manuelle = 1;
            var production_automatique = 0;

            //----------------------------------------------------------
            var mainGoat = $("#mainGoat");
            var lblGoats = $("#lblGoats");
            var goatclickproducer_cost = $("#goatclickproducer_cost");
           
            var btnSave = $("#btnSave");
            //----------------------------------------------------------

            if (retrievedObject != null) {

                lblGoats.text(retrievedObject.goats.replace(/\B(?=(\d{3})+(?!\d))/g, " "));
                nbClick = retrievedObject.nbClick;
                production_manuelle = retrievedObject.productionManuelle;
                production_automatique = retrievedObject.productionAutomatique;
            }
            else
            {
                retrievedObject = getSauvegardeObject();
                lblGoats.text(retrievedObject.goats.replace(/\B(?=(\d{3})+(?!\d))/g, " ")); 
            }

            function checkCompetences()
            {
                var competences = $(".competence");
                
                // parcourir les div compétences. Pour chaque, vérifier le prix, si argent dispo alors on permet l'achat
                for (var i = 0; i < competences.length; i++) {
                    var position = competences[i].getAttribute("position")
                    if(sysinfos.Magasins.Competences[position].Prix <= retrievedObject.goats)
                    {
                        competences[i].removeAttribute('disabled');
                    }
                    else
                    {
                        competences[i].setAttribute('disabled', 'disabled');
                    }
                };
            }  

            checkCompetences();

            /*
            BLOC TEST DAMIEN
            *
             */
            var si = new SysInfos();

            //  var banque = si.Banque;
            // var Magasin = si.Magasins
            // var Player = si.Player

            // on click goat
            //qté production lait :
            var qteLaitProduiteOnClick = si.Banque.GenererProduction(si.Player);
            // et donc si stockage :
            si.Player.LaitAccumule += si.Banque.GenererProduction(si.Player);
            // or
            si.GenererProductionClic();
            // TODO : faire chainons manquants pour rattrapage lors chargement sauvegarde
            // si.ApplyAutoClics();

            // génération revenu (si pas stockage, actions liées):
            var revenuOnClick = si.Banque.GenererRevenu(si.Player);

            // génération de click auto
            // (si.Player.FrequenceAutomaticClic * secondes) * Si.GenererProduction();
            // comme objets "internes" au si =>

            // achat goat => plus de production
            // TODO : ajouter goats aux magasins
          //  var goatAchetee;
          //  var priceAchat;
          //  if (si.Player.CanBuyGoat(goatAchetee, priceAchat)){
          //      si.Player.BuyGoat(goatAchetee, priceAchat);
          //  }
            //influera production future



            /*
                       FIN BLOC
                        */


           
            interval = setInterval(function() 
            { 
                retrievedObject.goats+= production_automatique; 
                setSauvegarde(retrievedObject);
                lblGoats.text(retrievedObject.goats.replace(/\B(?=(\d{3})+(?!\d))/g, " ")); 
                checkCompetences();
            }, 1000);           

            for (var i = 0; i < sysinfos.Magasins.Competences.length; i++) {
                var blocHtml = competenceToHtml(sysinfos.Magasins.Competences[i], i);

                $("#beginnerStore").append(blocHtml);
            }            

            $(".competence").click(function() {
                var possibiliteAchat = $(this).attr('disabled');

                if(possibiliteAchat == undefined)
                {
                    var position = $(this).attr('position');
                    var price = sysinfos.Magasins.Competences[position].Prix;
                    
                    var gain = sysinfos.Magasins.Competences[position].Gain;

                    retrievedObject.goats-=  Math.floor(price);  
                    
                    if(sysinfos.Magasins.Competences[position].GainManuel)
                    {
                        production_manuelle+= gain;
                    }
                    else
                    {
                        production_automatique+= gain;
                    }

                    sysinfos.Magasins.Competences[position].LevelStore++;
                    var niveau = sysinfos.Magasins.Competences[position].LevelStore;

                    retrievedObject.productionAutomatique = production_automatique;
                    retrievedObject.productionManuelle = production_manuelle;


                    // Calcul du prochain prix par rapport au niveau (trop linéaire pour le moment)
                    sysinfos.Magasins.Competences[position].Prix = Math.floor((sysinfos.Magasins.Competences[position].Prix * (niveau + 1)) + ((position * 20) * niveau));
                    sysinfos.Magasins.Competences[position].Gain = Math.floor((sysinfos.Magasins.Competences[position].Gain * (niveau + 1)) + ((position * 20) * niveau));

                    $("#goat" + position + "_cost").text(sysinfos.Magasins.Competences[position].Prix);
                    $("#goat" + position + "_gain").text(sysinfos.Magasins.Competences[position].Gain);

                    //lblGoats.text(retrievedObject.goats);

                    setSauvegarde(retrievedObject);

                    checkCompetences();
                }               
            });

            btnSave.click(function() {
                setSauvegarde(retrievedObject);
                alert('Sauvegarde effectuée');
            });

            mainGoat.click(function () {
                startSound("Sounds/chevre1-3.mp3");
                mainGoat.animate({
                    height : "-=20",
                    width : "-=20"
                }, 100);

                mainGoat.animate({
                    height : "+=20",
                    width : "+=20"
                }, 100);  

                retrievedObject.goats+= Math.floor(production_manuelle);

                retrievedObject.goats = Math.floor(retrievedObject.goats);
                nbClick++;
                lblGoats.text(retrievedObject.goats.replace(/\B(?=(\d{3})+(?!\d))/g, " "));
                               
                retrievedObject.nbClick = nbClick;

                setSauvegarde(retrievedObject);

                var label = $("<label>").attr('id', "lblplus");
                label.attr('class', 'plusone');

                label.insertAfter('#scoringclick');
                label.text("+" + production_manuelle);
                label.animate({
                    opacity: 0,
                    top: "-=30"
                }, "slow", function () {
                    label.remove();
                });  

                checkCompetences();            
            });

            $("#btnReinit").click(function () {
                clearInterval(interval);
                supprimerSauvegarde();
                nbClick = 0;
                lblGoats.text('0');
                retrievedObject = getSauvegardeObject();
                checkCompetences();
            });
        });
    </script>
</body>
</html>
